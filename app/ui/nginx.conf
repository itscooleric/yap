# Yap Unified UI - Nginx Configuration for Local Mode
# This config enables local development without Caddy by proxying
# /asr/* and /tts/* to the respective backend services.

server {
    listen 80;
    server_name localhost;

    root /usr/share/nginx/html;
    index index.html;

    # Serve static files
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Proxy ASR API requests
    # The whisper-asr backend expects requests at /asr endpoint
    location /asr {
        proxy_pass http://whisper-asr:9000/asr;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Increase timeouts for transcription
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
        
        # Handle large audio files
        client_max_body_size 100M;
    }

    # ASR health check endpoint - for container-to-container health checks
    location = /asr/health {
        proxy_pass http://whisper-asr:9000/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ASR docs/openapi endpoints
    location /asr-docs {
        proxy_pass http://whisper-asr:9000/docs;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    location /asr-openapi.json {
        proxy_pass http://whisper-asr:9000/openapi.json;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # Proxy TTS API requests - strip /tts prefix
    # Note: location /tts/ with trailing slash matches /tts/* paths
    location /tts/ {
        proxy_pass http://piper-tts:5000/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Increase timeouts for synthesis
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # TTS health check - explicit route for reliability
    location = /tts/health {
        proxy_pass http://piper-tts:5000/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # TTS root endpoint - handles /tts (without trailing slash)
    location = /tts {
        proxy_pass http://piper-tts:5000/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # Proxy Metrics API requests
    location /api/metrics/ {
        proxy_pass http://yap-metrics:8091/api/metrics/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Proxy LLM API requests - strip /api/llm prefix
    location /api/llm/ {
        proxy_pass http://yap-llm-proxy:8092/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # Increase timeouts for LLM requests
        proxy_connect_timeout 90s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }
}
