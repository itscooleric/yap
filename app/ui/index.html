<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yap - Speech Tools</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="container">
    <header>
      <div class="header-row">
        <div class="header-left">
          <h1>yap</h1>
          <div class="recording-indicator" id="recordingIndicator" title="Click to return to ASR">
            <span class="rec-dot"></span>
            <span>Recording <span id="recordingIndicatorTime">00:00</span></span>
          </div>
        </div>
        <nav class="nav-tabs">
          <button data-tab="asr" class="active">ASR</button>
          <button data-tab="tts">TTS</button>
          <button data-tab="data" id="dataTabBtn">Data</button>
          <button id="addonsBtn">Apps</button>
          <button id="settingsBtn" class="settings-btn" title="Settings">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/>
              <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
            </svg>
          </button>
        </nav>
      </div>
      <p class="tagline">local speech tools</p>
    </header>

    <main>
      <!-- ASR Tab -->
      <div id="asr-tab" class="tab-content active">
        <div class="panel">
          <div class="panel-header">Recording</div>

          <div class="waveform-container">
            <canvas id="waveform"></canvas>
          </div>

          <div class="status-bar">
            <div class="status">
              <span class="status-dot" id="asrStatusDot"></span>
              <span id="asrStatusText">Idle</span>
            </div>
            <div class="timer" id="timer">00:00</div>
          </div>

          <div class="controls">
            <button id="recordBtn" class="primary">Record</button>
            <button id="stopBtn" disabled>Stop</button>
            <button id="transcribeAllBtn" disabled>Transcribe All</button>
            <button id="clearBtn" disabled>Clear</button>
            <button id="asrUploadBtn" type="button">Upload</button>
          </div>

          <div class="form-group" style="margin-top: 0.5rem;">
            <!-- <span id="asrFileName" style="color: var(--text-secondary); font-size: 0.85rem;">No file selected</span> -->
            <input type="file" id="asrFileInput" accept="audio/*,.mp3,.wav,.webm,.ogg,.m4a,.flac" style="display: none;">
          </div>

          <div class="clips-list" id="clipsList">
            <div class="clips-list-header">
              <span class="clips-list-title">Clips</span>
              <span id="clipsCount" class="clips-list-title">0</span>
            </div>
            <div id="clipsContainer">
              <div class="no-clips">No clips recorded</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">Transcript</div>
          <textarea id="transcript" class="transcript-area" placeholder="Transcript will appear here..." readonly></textarea>

          <div class="output-controls">
            <button id="copyBtn" disabled title="Copy transcript">Copy</button>
            <button id="downloadTxtBtn" disabled>Download .txt</button>
            <button id="exportBtn" disabled title="Export to GitLab/GitHub/SFTP">Export</button>
          </div>

          <div id="asrMessage" class="message" style="display: none;"></div>
        </div>
      </div>

      <!-- TTS Tab -->
      <div id="tts-tab" class="tab-content">
        <div class="panel">
          <div class="panel-header">Text Input</div>

          <div class="form-group">
            <div class="tts-input-header">
              <label for="ttsTextInput">Text to synthesize:</label>
              <div class="tts-view-toggle">
                <button type="button" class="view-toggle-btn active" id="ttsViewPlain">Plain</button>
                <button type="button" class="view-toggle-btn" id="ttsViewMarkdown">Markdown</button>
              </div>
            </div>
            <textarea id="ttsTextInput" class="text-input" placeholder="Enter text to convert to speech..."></textarea>
            <div id="ttsMarkdownPreview" class="markdown-preview" style="display: none;"></div>
            <div class="char-count"><span id="charCount">0</span> characters</div>
          </div>

          <div class="form-group">
            <label>Or upload a text file:</label>
            <div class="file-input-wrapper">
              <button id="ttsUploadBtn" type="button">Choose .txt file</button>
              <span id="ttsFileName" style="color: var(--text-secondary); font-size: 0.85rem;">No file selected</span>
              <input type="file" id="ttsFileInput" accept=".txt,text/plain,.md">
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">Voice Settings</div>

          <div class="form-group">
            <label for="voiceSelect">Voice:</label>
            <select id="voiceSelect">
              <option value="">Loading voices...</option>
            </select>
          </div>

          <div class="form-group">
            <label for="rateSlider">Speaking Rate:</label>
            <div class="slider-container">
              <span style="font-size: 0.8rem; color: var(--text-secondary);">Fast</span>
              <input type="range" id="rateSlider" min="0.5" max="2.0" step="0.1" value="1.0">
              <span style="font-size: 0.8rem; color: var(--text-secondary);">Slow</span>
              <span class="slider-value" id="rateValue">1.0x</span>
            </div>
            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
              (length_scale: lower = faster, higher = slower)
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">Synthesis</div>

          <div class="status-bar">
            <div class="status">
              <span class="status-dot" id="ttsStatusDot"></span>
              <span id="ttsStatusText">Ready</span>
            </div>
          </div>

          <div class="controls">
            <button id="synthesizeBtn" class="primary" disabled>Synthesize</button>
            <button id="ttsClearBtn">Clear Text</button>
          </div>
        </div>

        <div class="panel" id="ttsOutputPanel" style="display: none;">
          <div class="panel-header">Output</div>

          <div class="audio-container">
            <audio id="ttsAudioPlayer" controls></audio>
          </div>

          <div class="output-controls">
            <button id="ttsPlayBtn">Play</button>
            <button id="ttsPlayReadAlongBtn" class="secondary">Play with Read-Along</button>
            <button id="ttsDownloadBtn">Download .wav</button>
          </div>

          <div id="ttsMessage" class="message" style="display: none;"></div>
        </div>
      </div>

      <!-- Read-Along Panel (modal) -->
      <div id="readAlongPanel" class="read-along-panel" style="display: none;">
        <div class="read-along-header">
          <span class="read-along-title">Read-Along</span>
          <div class="read-along-controls">
            <button id="readAlongPauseBtn" class="small">Pause</button>
            <button id="readAlongStopBtn" class="small">Stop</button>
            <button id="readAlongCloseBtn" class="small">âœ•</button>
          </div>
        </div>
        <div class="read-along-status" id="readAlongStatus">
          <span id="readAlongProgress">Chunk 0 / 0</span>
        </div>
        <div class="read-along-content" id="readAlongContent">
          <!-- Chunks will be rendered here -->
        </div>
      </div>

      <!-- Data Tab (Metrics/History) -->
      <div id="data-tab" class="tab-content">
        <div class="panel">
          <div class="panel-header">
            Metrics Summary
            <div class="panel-actions">
              <button class="small" id="refreshMetricsBtn" title="Refresh metrics">
                <svg style="width: 12px; height: 12px; vertical-align: middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M23 4v6h-6"/>
                  <path d="M1 20v-6h6"/>
                  <path d="M3.51 9a9 9 0 0114.85-3.36L23 10"/>
                  <path d="M20.49 15a9 9 0 01-14.85 3.36L1 14"/>
                </svg>
                Refresh
              </button>
              <label class="auto-refresh-toggle" title="Auto-refresh every 30 seconds">
                <input type="checkbox" id="autoRefreshToggle">
                <span style="font-size: 0.7rem;">Auto</span>
              </label>
            </div>
          </div>
          
          <div id="metricsDisabledNotice" class="notice">
            <p><strong>Metrics are disabled</strong></p>
            <p class="notice-hint">Track your ASR and TTS usage with local-only metrics. No data leaves your server.</p>
            <button id="enableMetricsBtn" class="primary" style="margin-top: 1rem;">Enable Metrics</button>
            <p class="notice-hint" style="margin-top: 0.5rem; font-size: 0.75rem;">You can also enable in Settings or set <code>METRICS_ENABLED=true</code> in docker environment.</p>
          </div>
          
          <div id="metricsSummary" style="display: none;">
            <div class="metrics-range-selector">
              <button class="range-btn active" data-range="today">Today</button>
              <button class="range-btn" data-range="7d">7 Days</button>
              <button class="range-btn" data-range="30d">30 Days</button>
              <button class="range-btn" data-range="all">All</button>
            </div>
            
            <div class="metrics-cards">
              <div class="metric-card">
                <div class="metric-value" id="metricAsrRecorded">0</div>
                <div class="metric-label">Minutes Recorded</div>
              </div>
              <div class="metric-card">
                <div class="metric-value" id="metricAsrTranscribed">0</div>
                <div class="metric-label">Minutes Transcribed</div>
              </div>
              <div class="metric-card">
                <div class="metric-value" id="metricTtsGenerated">0</div>
                <div class="metric-label">TTS Minutes</div>
              </div>
              <div class="metric-card">
                <div class="metric-value" id="metricTotalEvents">0</div>
                <div class="metric-label">Total Events</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="panel" id="metricsHistoryPanel" style="display: none;">
          <div class="panel-header">
            Event History
            <div class="panel-actions">
              <button class="small" id="exportHistoryBtn">Export JSON</button>
              <button class="small danger" id="clearHistoryBtn">Clear History</button>
            </div>
          </div>
          
          <div class="history-table-container">
            <table class="history-table" id="historyTable">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Type</th>
                  <th>Duration</th>
                  <th>Chars</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="historyTableBody">
                <tr><td colspan="5" class="no-data">No events recorded</td></tr>
              </tbody>
            </table>
          </div>
          
          <div class="pagination" id="historyPagination">
            <button class="small" id="historyPrevBtn" disabled>Previous</button>
            <span id="historyPageInfo">Page 1</span>
            <button class="small" id="historyNextBtn" disabled>Next</button>
          </div>
        </div>
        
        <div id="dataMessage" class="message" style="display: none;"></div>
      </div>
    </main>

    <footer>
      <p>YAP local speech tools</p>
    </footer>
  </div>

  <!-- Mobile Floating Action Cluster (persistent across tabs) -->
  <div id="mobileToolbar" class="mobile-fab-cluster" style="display: none;">
    <button id="mobileRecordBtn" class="fab-btn fab-primary" title="Record" data-mode="asr">
      <svg class="fab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="6"/>
      </svg>
      <svg class="fab-icon fab-icon-stop" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
        <rect x="6" y="6" width="12" height="12" rx="2"/>
      </svg>
    </button>
    <button id="mobileTranscribeBtn" class="fab-btn" disabled title="Transcribe" data-mode="asr">
      <svg class="fab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 18.5V5.5M12 5.5l-4 4M12 5.5l4 4"/>
        <path d="M4 12v5a2 2 0 002 2h12a2 2 0 002-2v-5"/>
      </svg>
      <span class="fab-spinner" style="display:none;"></span>
    </button>
    <button id="mobileCopyBtn" class="fab-btn" disabled title="Copy" data-mode="asr">
      <svg class="fab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="9" y="9" width="10" height="12" rx="2"/>
        <path d="M5 15V5a2 2 0 012-2h8"/>
      </svg>
    </button>
    <button id="mobileExportBtn" class="fab-btn" disabled title="Export" data-mode="asr">
      <svg class="fab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
        <polyline points="17 8 12 3 7 8"/>
        <line x1="12" y1="3" x2="12" y2="15"/>
      </svg>
    </button>
    <button id="mobileRefreshBtn" class="fab-btn" title="Refresh Data" data-mode="data" style="display:none;">
      <svg class="fab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M23 4v6h-6"/>
        <path d="M1 20v-6h6"/>
        <path d="M3.51 9a9 9 0 0114.85-3.36L23 10"/>
        <path d="M20.49 15a9 9 0 01-14.85 3.36L1 14"/>
      </svg>
    </button>
    <div class="fab-status" id="mobileStatus">
      <span class="fab-status-dot" id="mobileStatusDot"></span>
      <span id="mobileStatusText">Idle</span>
    </div>
  </div>
  
  <!-- Toast notification (global) -->
  <div id="toastNotification" class="toast-notification" style="display: none;"></div>

  <!-- Apps panel (hidden by default) -->
  <div class="addon-panel" id="addonPanel" style="display: none;">
    <div class="addon-panel-header">
      <span class="addon-panel-title">Apps</span>
      <button class="addon-window-close" id="addonPanelClose">x</button>
    </div>
    <div class="addon-panel-list" id="addonPanelList"></div>
  </div>

  <script type="module" src="/js/main.js"></script>
</body>
</html>
