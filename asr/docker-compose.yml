networks:
  caddy:
    external: true
    name: ${CADDY_NETWORK:-caddy}

services:
  whisper-asr:
    image: onerahmet/openai-whisper-asr-webservice:v1.9.1-gpu
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    restart: unless-stopped
    networks: [caddy]
    environment:
      ASR_ENGINE: ${ASR_ENGINE:-faster_whisper}
      ASR_MODEL: ${ASR_MODEL:-tiny.en}
      ASR_DEVICE: ${ASR_DEVICE:-cuda}
      ASR_MODEL_PATH: ${ASR_MODEL_PATH:-/models}
    volumes:
      - ${WHISPER_MODELS_PATH:-/srv/whisper-asr/models}:${ASR_MODEL_PATH:-/models}
    tmpfs:
      - /tmp

  yap-asr-ui:
    image: nginx:alpine
    restart: unless-stopped
    networks: [caddy]
    volumes:
      - ./ui:/usr/share/nginx/html:ro
    labels:
      caddy: ${ASR_DOMAIN:-asr.localhost}
      caddy.tls: internal
      caddy.1_@asrApi.path: /asr /asr/* /docs /docs/* /openapi.json /redoc /redoc/*
      caddy.2_reverse_proxy: "@asrApi whisper-asr:9000"
      caddy.3_reverse_proxy: "{{upstreams 80}}"
